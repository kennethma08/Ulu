@{
    ViewData["Title"] = "Live Agent WhatsApp";
}

@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.css" />
    <link rel="stylesheet" href="~/css/chat.css" asp-append-version="true" />
}

<div class="container-fluid p-0 vh-100 d-flex flex-column">
    <div class="card rounded-0 border-0 flex-grow-1 d-flex overflow-hidden">
        <div class="row g-0 flex-grow-1 h-100 overflow-hidden">

            <!-- Panel izq (desktop) -->
            <div class="col-12 col-lg-4 col-xl-3 border-end d-none d-lg-flex flex-column h-100 overflow-hidden">
                <div class="p-3">
                    <div class="row g-2">
                        <div class="col-8">
                            <input id="searchBox" type="text" class="form-control" placeholder="Filtrar conversaciones..." />
                        </div>
                        <div class="col-4">
                            <select id="statusFilter" class="form-select">
                                <option value="all" selected>All</option>
                                <option value="open">Open</option>
                                <option value="closed">Closed</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="users" class="list-group list-group-flush flex-grow-1 overflow-auto"></div>
            </div>

            <!-- Panel der (chat) -->
            <div class="col-12 col-lg-8 col-xl-9 d-flex flex-column overflow-hidden"
                 style="min-height:0; height:calc(100vh - 80px); height:calc(100dvh - 80px);">

                <!-- Header -->
                <div class="py-2 px-3 border-bottom" id="chat-header">
                    <div class="d-flex align-items-center flex-wrap gap-2">

                        <!-- Botón offcanvas (mobile) -->
                        <button class="btn btn-outline-secondary btn-sm d-lg-none btn-offcanvas order-0"
                                type="button"
                                data-bs-toggle="offcanvas"
                                data-bs-target="#convOffcanvas"
                                aria-controls="convOffcanvas">
                            <i class="bi bi-chat-left-text d-inline d-sm-none"></i>
                            <span class="d-none d-sm-inline">Conversaciones</span>
                        </button>

                        <!-- Avatar -->
                        <img id="chat-avatar"
                             src="https://static.vecteezy.com/system/resources/previews/002/318/271/original/user-profile-icon-free-vector.jpg"
                             class="rounded-circle order-1"
                             width="36"
                             height="36"
                             alt="avatar" />

                        <!-- Nombre + estado -->
                        <div class="flex-grow-1 min-w-0 order-2">
                            <div class="d-flex align-items-center flex-wrap gap-2">
                                <span id="chat-contact-name" class="fw-bold text-truncate-1">
                                    Selecciona una conversación
                                </span>
                                <button type="button"
                                        id="chat-btnEditName"
                                        class="icon-btn"
                                        title="Editar nombre"
                                        aria-label="Editar nombre">
                                    <i class="bx bx-pencil"></i>
                                </button>
                                <button type="button"
                                        id="chat-btnSaveName"
                                        class="btn btn-save btn-sm"
                                        style="display:none;">
                                    Guardar
                                </button>

                                <span id="statusBadge" class="badge"></span>
                                <span id="convNumber" class="badge conv-pill" style="display:none;"></span>
                            </div>
                            <div id="chat-contact-sub" class="small text-muted d-none d-sm-block"></div>
                            <div id="assignedInfo" class="small d-none d-sm-block"></div>
                        </div>

                        <!-- Controles de agente -->
                        <div class="d-flex align-items-center gap-2 ms-auto order-3">
                            <select id="agentSelect" class="form-select form-select-sm" style="max-width:220px;" disabled>
                                <option value="">Agentes...</option>
                            </select>

                            <button class="btn btn-sm btn-outline-primary" id="takeBtn" disabled>
                                Tomar
                            </button>

                            <button class="btn btn-sm btn-outline-secondary" id="releaseBtn" disabled>
                                Soltar
                            </button>

                            <button class="btn btn-sm btn-outline-warning" id="holdBtn" disabled>
                                En espera
                            </button>

                            <button class="btn btn-sm btn-outline-secondary"
                                    id="toggleStatusBtn"
                                    disabled>
                                Cerrar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Mensajes -->
                <div class="chat-messages flex-grow-1 overflow-auto p-3" id="messages"></div>

                <!-- Input -->
                <div class="border-top p-3 flex-shrink-0">
                    <div class="input-group">
                        <button class="btn btn-outline-secondary"
                                type="button"
                                id="btn-audio"
                                title="Enviar audio">
                            <i class="bi bi-mic-fill"></i>
                        </button>
                        <input type="file" id="audio-input" accept="audio/*" class="d-none" />
                        <input type="text"
                               id="message-input"
                               class="form-control"
                               placeholder="Escribe un mensaje..." />
                        <button class="btn btn-primary"
                                id="send-btn"
                                type="button">
                            Enviar
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<form id="chat-antiforgery" class="d-none">
    @Html.AntiForgeryToken()
</form>

<!-- Offcanvas mobile -->
<div class="offcanvas offcanvas-start custom-chat"
     tabindex="-1"
     id="convOffcanvas"
     aria-labelledby="convOffcanvasLabel"
     data-bs-backdrop="true">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="convOffcanvasLabel">Conversaciones</h5>
        <button type="button"
                class="btn-close text-reset"
                data-bs-dismiss="offcanvas"
                aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body">
        <div class="p-3 border-bottom">
            <div class="row g-2">
                <div class="col-8">
                    <input id="searchBoxMob"
                           type="text"
                           class="form-control"
                           placeholder="Filtrar conversaciones..." />
                </div>
                <div class="col-4">
                    <select id="statusFilterMob" class="form-select">
                        <option value="all" selected>All</option>
                        <option value="open">Open</option>
                        <option value="closed">Closed</option>
                    </select>
                </div>
            </div>
        </div>
        <div id="users-mob" class="list-group list-group-flush"></div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.polyfilled.min.js"></script>

    <!-- Config que necesita el JS estático (para preservar @Url.Action) -->
    <script>
        window.chatConfig = {
            actualizarNombreUrl: '@Url.Action("ActualizarNombre", "Contact")'
        };
    </script>

    <script src="~/js/chat.js" asp-append-version="true"></script>
}
